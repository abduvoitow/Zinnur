{% extends 'admin_panel/admin_base.html' %}
{% block content %}
{% load static %}
<!-- DataTables CSS (CDN) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<div class="container section-title" data-aos="fade-up" >
  <h2>Buyurtmalar</h2>
</div>
<div class="container">
  <div class="table-responsive">
    <table id="ordersTable" class="table table-hover table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Turi</th>
          <th>Ism</th>
          <th>Telefon</th>
          <th>Mahsulot</th>
          <th>Rasm</th>
          <th>Soni</th>
          <th>Sana</th>
          <th>Amallar</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr {% if o.status == 'yangi' %} style="background-color:#fffbe6;" {% endif %}>
          <td style="font-size: 2rem; text-align: center;">
            {% if o.type == 'paint' %} <img width="40rem" src="{% static 'img/order1.png' %}" alt=""> 
            {% elif o.type == 'furniture' %} <img width="40rem" src="{% static 'img/order2.png' %}" alt=""> 
            {% elif o.type == 'footwear' %} <img width="40rem" src="{% static 'img/order3.png' %}" alt=""> 
            {% else %}{{ o.type }}{% endif %}
          </td>
          <td class="fw-semibold">{{ o.full_name }}</td>
          <td class="text-center"><span class="badge bg-light text-dark border">{{ o.phone_number }}</span></td>
          <td><span class="badge bg-secondary">{{ o.product }}</span></td>
          <td class="text-center">
            <img src="{{ o.image.url }}" alt="{{ o.product.name }}" class="product-img-thumb" style="max-width:60px;max-height:60px;">
          </td>
          <td class="text-center"><span class="badge bg-warning text-dark">{{ o.quantity }}</span></td>
          <td class="text-center">
            <span class="badge bg-light text-dark border">{{ o.created_at|date:"d-m-Y H:i" }}</span> 
            {% if o.status == 'yangi' %}
            <span class="badge bg-warning text-dark">Yangi</span>
            {% endif %}
            
          </td>
    
          <td class="text-center">
            <div class="btn-group" role="group">
              {% if o.status == 'yangi' %}
                <button class="btn btn-success btn-sm me-1 d-flex align-items-center gap-1" onclick="updateStatusByType('{{ o.type }}', {{ o.id }}, 'qabul_qilingan')">
                  <i class="bi bi-check2-circle"></i> Qabul
                </button>
                <button class="btn btn-danger btn-sm d-flex align-items-center gap-1" onclick="updateStatusByType('{{ o.type }}', {{ o.id }}, 'bekor_qilingan')">
                  <i class="bi bi-x-circle"></i> Bekor
                </button>
              {% elif o.status == 'qabul_qilingan' %}
                <span class="text-success d-flex align-items-center gap-1"><i class="bi bi-check2-circle"></i> Qabul qilingan</span>
              {% elif o.status == 'bekor_qilingan' %}
                <span class="text-danger d-flex align-items-center gap-1"><i class="bi bi-x-circle"></i> Bekor qilingan</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">Buyurtmalar topilmadi.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
  <section id="blog-pagination" class="blog-pagination section">
    <div class="container">
      <div class="d-flex justify-content-center">
        <ul class="pagination pagination-lg">
          {% if page_obj.has_previous %}
            <li><a href="?page={{ page_obj.previous_page_number }}"><i class="bi bi-chevron-left"></i></a></li>
          {% else %}
            <li><a href="#"><i class="bi bi-chevron-left"></i></a></li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li><a class="active" href="?page={{ num }}">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li><a href="?page={{ num }}">{{ num }}</a></li>
            {% elif num == 1 or num == page_obj.paginator.num_pages %}
              <li><a href="?page={{ num }}">{{ num }}</a></li>
            {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
              <li><span>...</span></li>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <li><a  href="?page={{ page_obj.next_page_number }}"><i class="bi bi-chevron-right"></i></a></li>
          {% else %}
            <li><a  href="#"><i class="bi bi-chevron-right"></i></a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </section>
  {% endif %}
</div>

{% csrf_token %}
<script>
function updateStatusByType(type, orderId, newStatus) {
    fetch(`/admin-panel/update-status/${type}/${orderId}/${newStatus}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Xatolik yuz berdi!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Xatolik yuz berdi!');
    });
}
</script>
{% endblock %} 